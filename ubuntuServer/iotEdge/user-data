#cloud-config
#More details on the wifi setup here: https://gitlab.com/Bjorn_Samuelsson/raspberry-pi-cloud-init-wifi

# Enable password authentication with the SSH daemon
ssh_pwauth: true
hostname: pie1
# On first boot, set the (default) ubuntu user's password to "ubuntu" and
# expire user passwords
chpasswd:
  expire: true
  list:
    - ubuntu:ubuntu
write_files:
  - content: |
      network:
        version: 2
        wifis:
          wlan0:
            dhcp4: true
            access-points:
              "asdfasfd":
                password: "password"
    path: /etc/netplan/config.yaml
bootcmd:
  - 'systemctl disable systemd-networkd-wait-online.service'
  - 'systemctl mask systemd-networkd-wait-online.service'
runcmd:
  - 'rm /etc/netplan/??-cloud-init.yaml'
  - 'chmod go-r /etc/netplan/config.yaml'
  - 'netplan apply'
  #IoTEdge configuration
  - curl https://packages.microsoft.com/config/ubuntu/18.04/multiarch/prod.list > ./microsoft-prod.list
  - sudo cp ./microsoft-prod.list /etc/apt/sources.list.d/
  - curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
  - sudo cp ./microsoft.gpg /etc/apt/trusted.gpg.d/
  - sudo apt update
  - sudo apt-get install moby-engine -y
  - sudo apt-get install moby-cli -y
  - sudo apt-get install iotedge -y
  - sudo cp /boot/firmware/config.yaml /etc/iotedge/config.yaml
  - sudo systemctl restart iotedge
  - sudo systemctl status iotedge
  - sudo iotedge check
  #End IoTEdge configuration
